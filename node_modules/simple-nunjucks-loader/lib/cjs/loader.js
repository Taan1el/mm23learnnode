"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = nunjucksLoader;

var _path = _interopRequireDefault(require("path"));

var _constants = require("./constants");

var _doTransform = require("./do-transform");

var _getLoaderOptions = require("./get-loader-options");

var _getImportPath = require("./utils/get-import-path");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function nunjucksLoader(source) {
  const callback = this.async();
  const options = (0, _getLoaderOptions.getLoaderOptions)(this, callback);

  if (options === null) {
    return;
  }

  const normalizedSearchPaths = [].concat(options.searchPaths).map(_path.default.normalize);
  let resourcePathImport = (0, _getImportPath.getImportPath)(this.resourcePath, normalizedSearchPaths);
  (0, _doTransform.doTransform)(source, this, {
    resourcePathImport,
    normalizedSearchPaths,
    options
  }).then(function (result) {
    callback(null, result);
  }, function (error) {
    if (error.code === _constants.ERROR_MODULE_NOT_FOUND && error.message.includes("'glob'")) {
      return callback(new Error('Attempt to use dynamic assets ' + 'without optional "glob" dependency installed'));
    }

    callback(error);
  });
}